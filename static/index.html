<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Linear Regression - Data Upload</title>
    <link rel="stylesheet" href="/static/css/styles.css" />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
      (function () {
        const t = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", t);
      })();
    </script>
  </head>
  <body>
    <!-- Toast Container for Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Hidden Toast Templates -->
    <div id="toast-templates" style="display: none">
      <!-- Success Toast -->
      <div class="toast-success-template toast success">
        <div class="toast-header">
          <h4 class="toast-title"></h4>
          <button
            class="toast-close"
            onclick="this.parentElement.parentElement.remove()"
          >
            √ó
          </button>
        </div>
        <div class="toast-content"></div>
      </div>

      <!-- Error Toast -->
      <div class="toast-error-template toast error">
        <div class="toast-header">
          <h4 class="toast-title"></h4>
          <button
            class="toast-close"
            onclick="this.parentElement.parentElement.remove()"
          >
            √ó
          </button>
        </div>
        <div class="toast-content"></div>
      </div>

      <!-- Warning Toast (for quality reports) -->
      <div class="toast-warning-template toast warning">
        <div class="toast-header">
          <h4 class="toast-title"></h4>
          <button
            class="toast-close"
            onclick="this.parentElement.parentElement.remove()"
          >
            √ó
          </button>
        </div>
        <div class="toast-content"></div>
      </div>

      <!-- Error Toast with Actions -->
      <div class="toast-error-actions-template toast error">
        <div class="toast-header">
          <h4 class="toast-title"></h4>
          <button
            class="toast-close"
            onclick="this.parentElement.parentElement.remove()"
          >
            √ó
          </button>
        </div>
        <div class="toast-content"></div>
        <div class="toast-actions">
          <button class="btn btn-primary retry-btn">üîÑ Retry</button>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h2>RegressLab</h2>
        <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
      </div>
      
      <!-- User Info Section -->
      <div id="userInfo" class="user-info" style="display: none;">
        <div class="user-details">
          <span id="username">Guest</span>
          <button id="logoutBtn" class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>
      
      <a href="/static/index.html" class="nav-item active" data-step="1"
        >Data Upload</a
      >
      <div class="nav-item" data-step="2" id="trainingNavItem">Training Setup</div>
      <a href="/static/results.html" class="nav-item" data-step="3" id="resultsNavItem"
        >Results & Predict</a
      >
      <div class="nav-item" id="savedModelsNavItem" style="display: none;">Saved Models</div>
    </nav>

    <!-- Mobile Menu Toggle -->

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <!-- Page Header -->
        <div class="page-header">
          <div class="header-content">
            <div class="header-text">
              <h1>Univariate Regression Model Training</h1>
              <p>Upload your dataset and configure your regression model</p>
            </div>
            <button class="theme-toggle" id="themeBtn">üåô</button>
          </div>
        </div>
        <!-- Upload Section -->
        <div class="card">
          <div
            style="display: flex; justify-content: center; align-items: center"
          >
            <h3>Upload Your CSV Dataset</h3>
          </div>

          <div class="upload-zone" id="uploadZone">
            <div class="upload-content">
              <span class="upload-icon">üìÅ</span>
              <p>Click to upload or drag and drop your CSV file</p>
              <span class="upload-hint">Maximum file size: 10MB</span>
            </div>
            <input type="file" id="fileInput" accept=".csv" hidden />
          </div>
        </div>

        <!-- Preview Section -->
        <div class="card" id="previewSection" style="display: none">
          <div
            style="display: flex; justify-content: center; align-items: center"
          >
            <h3
              style="
                margin: 0;
                padding-bottom: 8px;
                border-bottom: 2px solid #3182ce;
              "
            >
              Data Preview
            </h3>
          </div>
          <div class="table-container">
            <table id="dataTable">
              <thead id="tableHead"></thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
          <div class="data-info">
            <span id="rowCount">Rows: 0</span>
            <span id="colCount">Columns: 0</span>
          </div>
        </div>

        <!-- Column Selection -->
        <div class="card" id="columnSection" style="display: none">
          <div
            style="display: flex; justify-content: center; align-items: center"
          >
            <h3 style="margin: 0; padding-bottom: 8px">
              Select X and Y Columns
            </h3>
          </div>
          <div class="column-selectors">
            <div class="selector-group">
              <select id="xColumn">
                <option value="">Select X column (Independent Variable)</option>
              </select>
            </div>
            <div class="selector-group">
              <select id="yColumn">
                <option value="">Select Y column (Dependent Variable)</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary" id="analyzeDataBtn" disabled>
            Analyze Data Quality
          </button>
        </div>

        <!-- Data Quality Analysis Section -->
        <div class="card" id="dataQualitySection" style="display: none">
          <div
            style="display: flex; justify-content: center; align-items: center"
          >
            <h3
              style="
                margin: 0;
                padding-bottom: 8px;
                border-bottom: 2px solid #3182ce;
              "
            >
              Data Quality Analysis
            </h3>
          </div>

          <div class="quality-report" id="qualityReport">
            <div class="loading-spinner">
              <div class="spinner"></div>
              <p>Analyzing your data quality...</p>
            </div>
          </div>

          <div
            class="quality-actions"
            id="qualityActions"
            style="display: none"
          >
            <button class="btn btn-success" id="proceedToCleaning">
              Configure Data Cleaning
            </button>
          </div>
        </div>

        <!-- Data Cleaning Section -->
        <div class="card" id="cleaningSection" style="display: none">
          <div
            style="display: flex; justify-content: center; align-items: center"
          >
            <h3
              style="
                margin: 0;
                padding-bottom: 8px;
                border-bottom: 2px solid #e53e3e;
              "
            >
              Data Cleaning Configuration
            </h3>
          </div>

          <div class="cleaning-options" id="cleaningOptions">
            <div class="cleaning-info">
              <div id="noIssuesMessage" style="display: none">
                <p style="color: #10b981; text-align: center; margin: 0px 0">
                  Data is already Clean.
                </p>
              </div>
            </div>

            <div class="cleaning-checkboxes">
              <div class="cleaning-option" id="missingValuesOption">
                <h4>Missing Values:</h4>
                <div class="radio-options">
                  <div class="radio-item">
                    <input
                      type="radio"
                      id="removeMissing"
                      name="missingValues"
                      value="remove"
                      checked
                    />
                    <label for="removeMissing"
                      >Remove rows with missing values</label
                    >
                  </div>
                  <div class="radio-item">
                    <input
                      type="radio"
                      id="fillMean"
                      name="missingValues"
                      value="mean"
                    />
                    <label for="fillMean"
                      >Fill missing values with column mean</label
                    >
                  </div>
                </div>
              </div>
              <!-- Add this between your missing values option and outliers option -->
              <div class="cleaning-option" id="duplicatesOption">
                <h4>Duplicate Rows:</h4>
                <div class="radio-options">
                  <div class="radio-item">
                    <input
                      type="radio"
                      id="removeDuplicates"
                      name="duplicates"
                      value="remove"
                      checked
                    />
                    <label for="removeDuplicates">Remove duplicate rows</label>
                  </div>
                  <div class="radio-item">
                    <input
                      type="radio"
                      id="keepDuplicates"
                      name="duplicates"
                      value="keep"
                    />
                    <label for="keepDuplicates">Keep duplicate rows</label>
                  </div>
                </div>
              </div>
              <div class="cleaning-option" id="outliersOption">
                <h4>Outliers:</h4>
                <div class="radio-options">
                  <div class="radio-item">
                    <input
                      type="radio"
                      id="keepOutliers"
                      name="outliers"
                      value="keep"
                      checked
                    />
                    <label for="keepOutliers">Keep outliers</label>
                  </div>
                  <div class="radio-item">
                    <input
                      type="radio"
                      id="removeOutliers"
                      name="outliers"
                      value="remove"
                    />
                    <label for="removeOutliers"
                      >Remove outliers (IQR method)</label
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="final-actions">
            <button class="btn btn-primary" id="cleanDataBtn">
              Clean Data & Display Visualizations
            </button>
          </div>
        </div>

        <!-- Visualization Section (hidden until data ready) -->
        <section
          id="visualizationSection"
          class="card"
          style="display: none; margin-top: 2rem"
        >
          <div class="card-header">
            <h3>Data Visualisation</h3>
          </div>

          <div class="visualization-grid">
            <div class="chart-container large">
              <div id="scatterChart"></div>
            </div>

            <div class="chart-container large">
              <div id="densityChart"></div>
            </div>

            <div class="chart-container">
              <div id="rangeChart"></div>
            </div>

            <div class="chart-container">
              <div id="statsChart"></div>
            </div>
          </div>

          <!-- Proceed to Training Button -->
          <div style="text-align: center; margin: 2rem 0">
            <button
              id="proceedToTrainBtn"
              class="btn btn-success btn-large"
              onclick="proceedToTraining()"
              disabled
            >
              Load Data to Enable Training
            </button>
          </div>
        </section>
      </div>
    </main>

    <script type="module" src="/static/js/script.js"></script>
    
    <script>
      // User Authentication Functions
      function checkUserAuth() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const sessionId = localStorage.getItem('session_id');
        
        if (user && sessionId) {
          // User is signed in
          document.getElementById('userInfo').style.display = 'block';
          document.getElementById('username').textContent = user.username;
          document.getElementById('savedModelsNavItem').style.display = 'block';
          
          // Make saved models nav item clickable
          document.getElementById('savedModelsNavItem').style.cursor = 'pointer';
          document.getElementById('savedModelsNavItem').onclick = () => {
            window.location.href = '/static/saved-models.html';
          };
          
          // For logged-in users: Training and Results nav items should be disabled until they have data
          document.getElementById('trainingNavItem').style.cursor = 'not-allowed';
          document.getElementById('trainingNavItem').onclick = () => {
            // Check if user has loaded data
            if (window.cleanedData && window.cleanedDataColumns) {
              window.location.href = '/static/training.html';
            } else {
              showMessage('Please load and clean data first to access training.', 'warning');
            }
          };
          
          document.getElementById('resultsNavItem').style.cursor = 'not-allowed';
          document.getElementById('resultsNavItem').onclick = () => {
            // Check if user has training data or selected model
            const trainingData = localStorage.getItem('allTrainingData');
            const selectedModelId = localStorage.getItem('selectedModelId');
            
            if (trainingData || selectedModelId) {
              // User has model data, allow access to results
              window.location.href = '/static/results.html';
            } else {
              // User must either train a new model or select a saved model
              showMessage('Please either train a new model or select a saved model to view results.', 'warning');
            }
          };
          
          // Add disabled class to training and results nav items for logged-in users
          document.getElementById('trainingNavItem').classList.add('disabled');
          document.getElementById('resultsNavItem').classList.add('disabled');
        } else {
          // User is guest
          document.getElementById('userInfo').style.display = 'none';
          document.getElementById('savedModelsNavItem').style.display = 'none';
          
          // For guests: Training and Results nav items should be disabled until they have data
          document.getElementById('trainingNavItem').style.cursor = 'not-allowed';
          document.getElementById('trainingNavItem').onclick = () => {
            // Check if user has loaded data
            if (window.cleanedData && window.cleanedDataColumns) {
              window.location.href = '/static/training.html';
            } else {
              showMessage('Please load and clean data first to access training.', 'warning');
            }
          };
          
          document.getElementById('resultsNavItem').style.cursor = 'not-allowed';
          document.getElementById('resultsNavItem').onclick = () => {
            // Check if user has training data
            const trainingData = localStorage.getItem('allTrainingData');
            
            if (trainingData) {
              // User has training data, allow access to results
              window.location.href = '/static/results.html';
            } else {
              // User must complete training first
              showMessage('Please complete model training to view results.', 'warning');
            }
          };
          
          // Add disabled class to training and results nav items for guests
          document.getElementById('trainingNavItem').classList.add('disabled');
          document.getElementById('resultsNavItem').classList.add('disabled');
        }
      }
      
      // Show message function
      function showMessage(message, type) {
        // Create a temporary message display
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}-message`;
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 1rem;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          z-index: 1000;
          max-width: 300px;
        `;
        
        if (type === 'warning') {
          messageDiv.style.backgroundColor = '#f39c12';
        } else if (type === 'error') {
          messageDiv.style.backgroundColor = '#e74c3c';
        } else {
          messageDiv.style.backgroundColor = '#27ae60';
        }
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
          messageDiv.remove();
        }, 4000);
      }
      
      function logout() {
        const sessionId = localStorage.getItem('session_id');
        
        if (sessionId) {
          // Call logout API
          fetch('/api/v1/auth/signout', {
            method: 'POST',
            headers: {
              'Cookie': `session_id=${sessionId}`
            }
          }).catch(error => console.error('Logout error:', error));
        }
        
        // Clear local storage
        localStorage.removeItem('user');
        localStorage.removeItem('session_id');
        
        // Redirect to login page
        window.location.href = '/';
      }
      
      // Check auth on page load
      document.addEventListener('DOMContentLoaded', checkUserAuth);
      
      // Check if data is already loaded and enable training button if so
      function checkDataState() {
        if (window.cleanedData && window.cleanedDataColumns) {
          // Enable the training button
          const proceedBtn = document.getElementById('proceedToTrainBtn');
          if (proceedBtn) {
            proceedBtn.disabled = false;
            proceedBtn.textContent = 'Proceed to Model Training';
          }
          
          // Enable the training navigation item
          const trainingNavItem = document.getElementById('trainingNavItem');
          if (trainingNavItem) {
            trainingNavItem.style.cursor = 'pointer';
            trainingNavItem.classList.remove('disabled');
            trainingNavItem.onclick = () => {
              window.location.href = '/static/training.html';
            };
          }
        }
      }
      
      // Also check when page becomes visible (user navigates back)
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
          checkDataState();
        }
      });
      
      // Validate session only for authenticated users
      async function validateSession() {
        const sessionId = localStorage.getItem('session_id');
        const user = localStorage.getItem('user');
        
        // If no session, user is guest - allow access
        if (!sessionId || !user) {
          return true;
        }
        
        // User has session, validate it
        try {
          const response = await fetch('/api/v1/auth/me', {
            headers: {
              'Cookie': `session_id=${sessionId}`
            }
          });
          
          const result = await response.json();
          
          if (!result.authenticated) {
            // Invalid session, clear storage but allow as guest
            clearUserData();
            return true;
          }
          
          return true;
        } catch (error) {
          // Network error, clear storage but allow as guest
          clearUserData();
          return true;
        }
      }
      
      function clearUserData() {
        localStorage.removeItem('user');
        localStorage.removeItem('session_id');
        localStorage.removeItem('allTrainingData');
        localStorage.removeItem('selectedModelId');
        localStorage.removeItem('session_timestamp');
        localStorage.removeItem('last_page');
      }
      
      // Update session timestamp on user activity
      function updateSessionTimestamp() {
        const sessionId = localStorage.getItem('session_id');
        if (sessionId) {
          localStorage.setItem('session_timestamp', Date.now().toString());
        }
      }
      
      // Monitor user activity
      function startActivityMonitoring() {
        const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        events.forEach(event => {
          document.addEventListener(event, updateSessionTimestamp, true);
        });
      }
      
      // Block back/forward navigation more aggressively
      function blockNavigation() {
        // Disable back button
        history.pushState(null, null, location.href);
        window.addEventListener('popstate', function() {
          history.pushState(null, null, location.href);
          // Force redirect to login if trying to go back
          const sessionId = localStorage.getItem('session_id');
          if (sessionId) {
            clearUserData();
            window.location.href = '/';
          }
        });
        
        // Block forward button
        window.addEventListener('pageshow', function(event) {
          if (event.persisted) {
            // Page loaded from cache (back/forward), redirect to login
            const sessionId = localStorage.getItem('session_id');
            if (sessionId) {
              clearUserData();
              window.location.href = '/';
            }
          }
        });
      }
      
      // EVEN EARLIER CHECK: Block before page loads
      document.addEventListener('DOMContentLoaded', () => {
        const lastPage = localStorage.getItem('last_page');
        const sessionId = localStorage.getItem('session_id');
        
        // Only block if user has NO session but last_page is 'login'
        // This indicates a back navigation attempt without authentication
        if (lastPage === 'login' && !sessionId) {
          // User navigated back from login without signing in
          localStorage.removeItem('last_page');
          window.location.href = '/';
          return;
        }
      });
      
      // Check session validity on page load
      window.addEventListener('load', async () => {
        // IMMEDIATE CHECK: Block if user just came from login without session
        const lastPage = localStorage.getItem('last_page');
        const sessionId = localStorage.getItem('session_id');
        
        // Only block if user has NO session but last_page is 'login'
        if (lastPage === 'login' && !sessionId) {
          // User just navigated back from login without signing in
          localStorage.removeItem('last_page');
          window.location.href = '/';
          return;
        }
        
        await validateSession();
        checkUserAuth();
        checkDataState();
        
        // Start session heartbeat for authenticated users
        const sessionId2 = localStorage.getItem('session_id');
        const user = localStorage.getItem('user');
        if (sessionId2 && user) {
          startSessionHeartbeat();
          startActivityMonitoring();
          blockNavigation(); // Block navigation for authenticated users
        }
      });
      
      // Check session on page focus (when user returns to tab)
      window.addEventListener('focus', async () => {
        await validateSession();
        checkUserAuth();
      });
      
      // Check session on page visibility change
      document.addEventListener('visibilitychange', async () => {
        if (!document.hidden) {
          await validateSession();
          checkUserAuth();
        }
      });
      
      // Session heartbeat system - continuously validate session
      let sessionHeartbeat;
      
      function startSessionHeartbeat() {
        // Check session every 5 seconds
        sessionHeartbeat = setInterval(async () => {
          await validateSession();
          checkUserAuth();
        }, 5000);
      }
      
      function stopSessionHeartbeat() {
        if (sessionHeartbeat) {
          clearInterval(sessionHeartbeat);
          sessionHeartbeat = null;
        }
      }
      
      // Enhanced session validation with redirect protection
      async function validateSession() {
        const sessionId = localStorage.getItem('session_id');
        const user = localStorage.getItem('user');
        const sessionTimestamp = localStorage.getItem('session_timestamp');
        const lastPage = localStorage.getItem('last_page');
        
        // If no session, user is guest - allow access
        if (!sessionId || !user) {
          // Set current page as last visited
          localStorage.setItem('last_page', 'index');
          return true;
        }
        
        // Check if user is trying to access from login page without proper authentication
        // This would only happen with back navigation after failed login
        if (lastPage === 'login') {
          // Clear the last_page and continue (user might have signed in)
          localStorage.removeItem('last_page');
        }
        
        // Check if session is too old (more than 24 hours)
        if (sessionTimestamp) {
          const sessionAge = Date.now() - parseInt(sessionTimestamp);
          const maxSessionAge = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
          
          if (sessionAge > maxSessionAge) {
            // Session too old, clear storage and redirect to login
            clearUserData();
            window.location.href = '/';
            return false;
          }
        }
        
        // User has session, validate it
        try {
          const response = await fetch('/api/v1/auth/me', {
            headers: {
              'Cookie': `session_id=${sessionId}`
            }
          });
          
          const result = await response.json();
          
          if (!result.authenticated) {
            // Invalid session, clear storage and redirect to login
            clearUserData();
            window.location.href = '/';
            return false;
          }
          
          // Set current page as last visited
          localStorage.setItem('last_page', 'index');
          return true;
        } catch (error) {
          // Network error, clear storage and redirect to login
          clearUserData();
          window.location.href = '/';
          return false;
        }
      }
      
      // Check session validity on page load
      window.addEventListener('load', async () => {
        await validateSession();
        checkUserAuth();
        checkDataState();
        
        // Start session heartbeat for authenticated users
        const sessionId = localStorage.getItem('session_id');
        const user = localStorage.getItem('user');
        if (sessionId && user) {
          startSessionHeartbeat();
        }
      });
      
      // Check session on page focus (when user returns to tab)
      window.addEventListener('focus', async () => {
        await validateSession();
        checkUserAuth();
      });
      
      // Check session on page visibility change
      document.addEventListener('visibilitychange', async () => {
        if (!document.hidden) {
          await validateSession();
          checkUserAuth();
        }
      });
      
      // Additional protection against browser navigation
      window.addEventListener('pageshow', async (event) => {
        // This event fires when page is loaded from cache (back/forward)
        if (event.persisted) {
          // Page was loaded from cache, validate session immediately
          await validateSession();
          checkUserAuth();
        }
      });
      
      // Protect against beforeunload (when user tries to navigate away)
      window.addEventListener('beforeunload', () => {
        // Clear heartbeat when leaving page
        stopSessionHeartbeat();
      });
    </script>
  </body>
</html>
