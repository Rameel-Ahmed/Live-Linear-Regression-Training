<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <script>
      (function () {
        const t = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", t);
      })();
    </script>
    <title>Results & Predictions - Linear Regression</title>
    <link rel="stylesheet" href="/static/css/styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>
  <body>
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <div
          style="
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 6px;
            margin-bottom: 10px;
          "
        >
          <h2 style="margin: 0; font-size: 1.6rem">
            Univariate Linear Regression
          </h2>
        </div>
        <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
      </div>
      <!-- User Info Section -->
      <div id="userInfo" class="user-info" style="display: none;">
        <div class="user-details">
          <span id="username">Guest</span>
          <button id="logoutBtn" class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>
      
      <a href="/static/index.html" class="nav-item" data-step="1"
        >Data Upload</a
      >
      <div class="nav-item" data-step="2" id="trainingNavItem">Training Setup</div>
      <a href="/static/results.html" class="nav-item active" data-step="3"
        >Results & Predict</a
      >
      <div class="nav-item" id="savedModelsNavItem" style="display: none;">Saved Models</div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Header -->
      <div class="page-header">
        <div class="header-content">
          <div class="header-text">
            <h1>Model Results & Predictions</h1>
            <p>Analyze your trained model and make predictions on new data</p>
          </div>
        </div>
      </div>

      <!-- Training Success Banner -->
      <!-- <div class="success-banner" id="successBanner">
            <div class="banner-content">
                <div class="banner-text">
                    <h3>Training Completed Successfully!</h3>
                    <p>Your linear regression model has been trained and is ready for predictions</p>
                </div>
                <span class="banner-close" onclick="closeBanner()">√ó</span>
            </div>
        </div> -->

      <!-- Results Layout -->
      <div class="results-layout">
        <!-- Left Column -->
        <div class="results-left">
          <!-- Make Predictions -->
          <div class="card predictions-card">
            <div
              style="
                display: flex;
                justify-content: center;
                align-items: center;
                padding-bottom: 6px;
                margin-bottom: 10px;
              "
            >
              <h3 style="margin: 0; font-size: 1.3rem">Make Predictions</h3>
            </div>
            <div class="equation-container">
              <div class="equation-display-large" id="predictionEquation">
                y = 2.5000x + 1.2000
              </div>
            </div>

            <div class="prediction-section">
              <h4>Single Prediction</h4>
              <div class="single-prediction">
                <div class="prediction-input">
                  <input
                    type="number"
                    id="xValue"
                    placeholder="Enter X value"
                    step="any"
                  />
                </div>
                <div class="prediction-buttons">
                  <button class="predict-btn" id="predictSingle">
                    Predict
                  </button>
                  <button class="clear-btn" id="clearSingle">Clear</button>
                </div>
              </div>

              <div
                class="prediction-result"
                id="predictionResult"
                style="display: none"
              >
                <div class="result-display">
                  <span class="result-label">Predicted Y:</span>
                  <span class="result-value" id="predictedValue">-</span>
                </div>
              </div>
            </div>

            <div class="batch-section">
              <h4>Batch Predictions</h4>
              <p class="batch-description">
                Upload a CSV file with X values to get predictions for multiple
                data points
              </p>

              <div class="batch-upload" id="batchUploadZone">
                <div class="upload-content">
                  <span class="upload-icon">üìÅ</span>
                  <p>Drop CSV file here or click to browse</p>
                  <span class="upload-hint"
                    >File should contain X values in any column</span
                  >
                </div>
                <input type="file" id="batchFileInput" accept=".csv" hidden />
              </div>

              <!-- Column Selection Section -->
              <div
                class="column-selection"
                id="columnSelection"
                style="display: none"
              >
                <h5>Select X Column</h5>
                <p>Choose which column contains the X values for prediction:</p>
                <div class="column-selector">
                  <select id="xColumnSelect">
                    <option value="">-- Select X Column --</option>
                  </select>
                  <button class="btn btn-primary" id="generatePredictions">
                    Generate Predictions
                  </button>
                </div>
              </div>

              <!-- CSV Preview Section -->
              <div class="card" id="csvPreview" style="display: none">
                <div
                  style="
                    display: flex;
                    justify-content: center;
                    align-items: center;
                  "
                >
                  <h3
                    style="
                      margin: 0;
                      padding-bottom: 8px;
                      border-bottom: 2px solid #3182ce;
                    "
                  >
                    CSV Preview
                  </h3>
                </div>
                <div class="table-container">
                  <table id="previewTable">
                    <thead id="previewTableHead"></thead>
                    <tbody id="previewTableBody"></tbody>
                  </table>
                </div>
                <div class="data-info">
                  <span id="csvRowCount">Rows: 0</span>
                  <span id="csvColCount">Columns: 0</span>
                </div>
              </div>

              <div
                class="batch-results"
                id="batchResults"
                style="display: none"
              >
                <div class="batch-summary">
                  <span id="batchCount">0 predictions made</span>
                  <button class="download-batch-btn" id="downloadBatchResults">
                    Download Results
                  </button>
                </div>
                <div class="batch-preview">
                  <div class="table-container">
                    <table id="batchTable">
                      <thead>
                        <tr>
                          <th>X Value</th>
                          <th>Predicted Y</th>
                        </tr>
                      </thead>
                      <tbody id="batchTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Model Comparison -->
          <div class="card comparison-card">
            <div
              style="
                display: flex;
                justify-content: center;
                align-items: center;
                padding-bottom: 6px;
                margin-bottom: 10px;
              "
            >
              <h3 style="margin: 0; font-size: 1.3rem">
                Model Comparison with Scikit-Learn
              </h3>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Metric</th>
                    <th>Our Model</th>
                    <th>Sklearn Model</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>R¬≤ Score</td>
                    <td id="ourModelR2">0.8945</td>
                    <td id="sklearnR2">0.9002</td>
                  </tr>
                  <tr>
                    <td>RMSE</td>
                    <td id="ourModelRmse">0.000234</td>
                    <td id="sklearnRmse">0.000198</td>
                  </tr>
                  <tr>
                    <td>MAE</td>
                    <td id="ourModelMae">0.000123</td>
                    <td id="sklearnMae">0.000098</td>
                  </tr>
                  <tr>
                    <td>Equation</td>
                    <td id="ourModelEquation">y = 2.5000x + 1.2000</td>
                    <td id="sklearnEquation">y = 2.4987x + 1.1989</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Model Saving Section (Only for signed-in users) -->
          <div class="card model-saving-card" id="modelSavingCard" style="display: none;">
            <div
              style="
                display: flex;
                justify-content: center;
                align-items: center;
                padding-bottom: 6px;
                margin-bottom: 10px;
              "
            >
              <h3 style="margin: 0; font-size: 1.3rem">Save Model</h3>
            </div>
            
            <div class="model-saving-form">
              <div class="form-group">
                <label for="modelName">Model Name:</label>
                <input type="text" id="modelName" placeholder="Enter model name" maxlength="50">
              </div>
              <button class="btn btn-primary" id="saveModelBtn" onclick="saveModel()">
                üíæ Save Model
              </button>
            </div>
            
            <div id="saveModelMessage" class="save-message" style="display: none;"></div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="results-right">
          <!-- Training Parameters -->
          <div class="card training-params-card">
            <div
              style="
                display: flex;
                justify-content: center;
                align-items: center;
                padding-bottom: 6px;
                margin-bottom: 10px;
              "
            >
              <h3 style="margin: 0; font-size: 1.3rem">Parameters Summary</h3>
            </div>

            <div class="params-grid">
              <div class="param-row">
                <span class="param-name">Learning Rate:</span>
                <span class="param-value" id="learningRateValue">0.01</span>
              </div>
              <div class="param-row">
                <span class="param-name">Epochs:</span>
                <span class="param-value" id="epochsValue">100</span>
              </div>
              <div class="param-row">
                <span class="param-name">Tolerance:</span>
                <span class="param-value" id="toleranceValue">0.0001</span>
              </div>
              <div class="param-row">
                <span class="param-name">Early Stopping:</span>
                <span class="param-value" id="earlyStoppingValue">Yes</span>
              </div>
              <div class="param-row">
                <span class="param-name">Training Speed:</span>
                <span class="param-value" id="trainingSpeedValue">1.0</span>
              </div>
              <div class="param-row">
                <span class="param-name">Train Split:</span>
                <span class="param-value" id="trainSplit">80%</span>
              </div>
              <div class="param-row">
                <span class="param-name">X Column:</span>
                <span class="param-value" id="xColumnValue">X</span>
              </div>
              <div class="param-row">
                <span class="param-name">Y Column:</span>
                <span class="param-value" id="yColumnValue">Y</span>
              </div>
            </div>
          </div>

          <!-- Download Reports -->
          <div class="card downloads-card">
            <div
              style="
                display: flex;
                justify-content: center;
                align-items: center;
                padding-bottom: 6px;
                margin-bottom: 10px;
              "
            >
              <h3 style="margin: 0; font-size: 1.3rem">Download Report</h3>
            </div>
            <div class="download-grid">
              <div class="download-item">
                <div class="download-info"></div>
                <button class="download-btn" id="downloadPDF">
                  Download Model Summary
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script type="module" src="/static/js/results.js?v=3"></script>
    
    <script>
      // User Authentication Functions
      function checkUserAuth() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const sessionId = localStorage.getItem('session_id');
        
        if (user && sessionId) {
          // User is signed in
          document.getElementById('userInfo').style.display = 'block';
          document.getElementById('username').textContent = user.username;
          document.getElementById('savedModelsNavItem').style.display = 'block';
          
          // Check if this is a saved model or newly trained model
          const selectedModelId = localStorage.getItem('selectedModelId');
          const trainingData = localStorage.getItem('allTrainingData');
          
          // Only show save model button if this is a newly trained model (not a saved model)
          if (trainingData && !selectedModelId) {
            document.getElementById('modelSavingCard').style.display = 'block';
          } else {
            document.getElementById('modelSavingCard').style.display = 'none';
          }
          
          // Make saved models nav item clickable
          document.getElementById('savedModelsNavItem').style.cursor = 'pointer';
          document.getElementById('savedModelsNavItem').onclick = () => {
            window.location.href = '/static/saved-models.html';
          };
          
          // For logged-in users: Training nav item should be disabled until they have data
          document.getElementById('trainingNavItem').style.cursor = 'not-allowed';
          document.getElementById('trainingNavItem').onclick = () => {
            // Check if user has loaded data
            if (window.cleanedData && window.cleanedDataColumns) {
              window.location.href = '/static/training.html';
            } else {
              showMessage('Please load and clean data first to access training.', 'warning');
            }
          };
          
          // Add disabled class to training nav item for logged-in users
          document.getElementById('trainingNavItem').classList.add('disabled');
        } else {
          // User is guest
          document.getElementById('userInfo').style.display = 'none';
          document.getElementById('savedModelsNavItem').style.display = 'none';
          document.getElementById('modelSavingCard').style.display = 'none';
          
          // For guests: Training nav item should be disabled until they have data
          document.getElementById('trainingNavItem').style.cursor = 'not-allowed';
          document.getElementById('trainingNavItem').onclick = () => {
            // Check if user has loaded data
            if (window.cleanedData && window.cleanedDataColumns) {
              window.location.href = '/static/training.html';
            } else {
              showMessage('Please load and clean data first to access training.', 'warning');
            }
          };
          
          // Add disabled class to training nav item for guests
          document.getElementById('trainingNavItem').classList.add('disabled');
        }
      }
      
      function logout() {
        const sessionId = localStorage.getItem('session_id');
        
        if (sessionId) {
          // Call logout API
          fetch('/api/v1/auth/signout', {
            method: 'POST',
            headers: {
              'Cookie': `session_id=${sessionId}`
            }
          }).catch(error => console.error('Logout error:', error));
        }
        
        // Clear local storage
        localStorage.removeItem('user');
        localStorage.removeItem('session_id');
        
        // Redirect to login page
        window.location.href = '/';
      }
      
      // Model Saving Function
      async function saveModel() {
        const modelName = document.getElementById('modelName').value.trim();
        if (!modelName) {
          showSaveMessage('Please enter a model name', 'error');
          return;
        }
        
        // Get current model data from the page with error handling
        try {
          // Get the actual training data directly from localStorage (the same data used to render the page)
          const trainingDataStr = localStorage.getItem('allTrainingData');
          if (!trainingDataStr) {
            showSaveMessage('No training data found. Please complete training first.', 'error');
            return;
          }
          
          const trainingData = JSON.parse(trainingDataStr);
          console.log('Training data for saving:', trainingData); // Debug
          
          // Extract the actual values that were used to render the page
          const modelData = {
            model_name: modelName,
            theta_1: trainingData.final_theta1, // slope (coefficient of x)
            theta_0: trainingData.final_theta0, // y-intercept
            rmse: trainingData.final_rmse || 0,
            mae: trainingData.final_mae || 0,
            r2_score: trainingData.final_r2 || 0,
            sklearn_rmse: trainingData.sklearn_comparison?.sklearn_results?.rmse || null,
            sklearn_mae: trainingData.sklearn_comparison?.sklearn_results?.mae || null,
            sklearn_r2: trainingData.sklearn_comparison?.sklearn_results?.r2_score || null
          };
          
          // Validate that we have the essential data
          if (isNaN(modelData.theta_0) || isNaN(modelData.theta_1)) {
            showSaveMessage('Invalid model parameters. Please ensure training is complete.', 'error');
            return;
          }
          
                    // Continue with saving...
          await saveModelToServer(modelData);
          
        } catch (error) {
          console.error('Error preparing model data:', error);
          showSaveMessage('Error preparing model data. Please ensure all values are valid.', 'error');
        }
      }
      
      // Separate function to save model to server
      async function saveModelToServer(modelData) {
        try {
          const formData = new FormData();
          Object.keys(modelData).forEach(key => {
            if (modelData[key] !== null && modelData[key] !== undefined) {
              formData.append(key, modelData[key]);
            }
          });
          
          const response = await fetch('/api/v1/auth/save-model', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            showSaveMessage('Model saved successfully!', 'success');
            document.getElementById('modelName').value = '';
          } else {
            showSaveMessage('Failed to save model: ' + result.detail, 'error');
          }
        } catch (error) {
          showSaveMessage('Error saving model: ' + error.message, 'error');
        }
      }
      
      function showSaveMessage(message, type) {
        const messageElement = document.getElementById('saveModelMessage');
        messageElement.textContent = message;
        messageElement.className = `save-message ${type}`;
        messageElement.style.display = 'block';
        
        setTimeout(() => {
          messageElement.style.display = 'none';
        }, 5000);
      }
      
      // Check auth on page load
      document.addEventListener('DOMContentLoaded', checkUserAuth);
      
      // Validate session only for authenticated users
      async function validateSession() {
        const sessionId = localStorage.getItem('session_id');
        const user = localStorage.getItem('user');
        
        // If no session, user is guest - allow access
        if (!sessionId || !user) {
          return true;
        }
        
        // User has session, validate it
        try {
          const response = await fetch('/api/v1/auth/me', {
            headers: {
              'Cookie': `session_id=${sessionId}`
            }
          });
          
          const result = await response.json();
          
          if (!result.authenticated) {
            // Invalid session, clear storage but allow as guest
            clearUserData();
            return true;
          }
          
          return true;
        } catch (error) {
          // Network error, clear storage but allow as guest
          clearUserData();
          return true;
        }
      }
      
      function clearUserData() {
        localStorage.removeItem('user');
        localStorage.removeItem('session_id');
        localStorage.removeItem('allTrainingData');
        localStorage.removeItem('selectedModelId');
      }
      
      // Check session validity on page load
      window.addEventListener('load', async () => {
        await validateSession();
        checkUserAuth();
        
        // Start session heartbeat for authenticated users
        const sessionId = localStorage.getItem('session_id');
        const user = localStorage.getItem('user');
        if (sessionId && user) {
          startSessionHeartbeat();
        }
      });
      
      // Check session on page focus (when user returns to tab)
      window.addEventListener('focus', async () => {
        await validateSession();
        checkUserAuth();
      });
      
      // Check session on page visibility change
      document.addEventListener('visibilitychange', async () => {
        if (!document.hidden) {
          await validateSession();
          checkUserAuth();
        }
      });
      
      // Session heartbeat system - continuously validate session
      let sessionHeartbeat;
      
      function startSessionHeartbeat() {
        // Check session every 5 seconds
        sessionHeartbeat = setInterval(async () => {
          await validateSession();
          checkUserAuth();
        }, 5000);
      }
      
      function stopSessionHeartbeat() {
        if (sessionHeartbeat) {
          clearInterval(sessionHeartbeat);
          sessionHeartbeat = null;
        }
      }
      
      // Enhanced session validation with redirect protection
      async function validateSession() {
        const sessionId = localStorage.getItem('session_id');
        const user = localStorage.getItem('user');
        
        // If no session, user is guest - allow access
        if (!sessionId || !user) {
          return true;
        }
        
        // User has session, validate it
        try {
          const response = await fetch('/api/v1/auth/me', {
            headers: {
              'Cookie': `session_id=${sessionId}`
            }
          });
          
          const result = await response.json();
          
          if (!result.authenticated) {
            // Invalid session, clear storage and redirect to login
            clearUserData();
            window.location.href = '/';
            return false;
          }
          
          return true;
        } catch (error) {
          // Network error, clear storage and redirect to login
          clearUserData();
          window.location.href = '/';
          return false;
        }
      }
      
      // Additional protection against browser navigation
      window.addEventListener('pageshow', async (event) => {
        // This event fires when page is loaded from cache (back/forward)
        if (event.persisted) {
          // Page was loaded from cache, validate session immediately
          await validateSession();
          checkUserAuth();
        }
      });
      
      // Protect against beforeunload (when user tries to navigate away)
      window.addEventListener('beforeunload', () => {
        // Clear heartbeat when leaving page
        stopSessionHeartbeat();
      });
      
      // Show message function
      function showMessage(message, type) {
        // Create a temporary message display
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}-message`;
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 1rem;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          z-index: 1000;
          max-width: 300px;
        `;
        
        if (type === 'warning') {
          messageDiv.style.backgroundColor = '#f39c12';
        } else if (type === 'error') {
          messageDiv.style.backgroundColor = '#e74c3c';
        } else {
          messageDiv.style.backgroundColor = '#27ae60';
        }
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
          messageDiv.remove();
        }, 4000);
      }
    </script>
  </body>
</html>
